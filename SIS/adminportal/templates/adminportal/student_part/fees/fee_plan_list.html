{% extends 'adminportal/base_adminportal.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Fee Plans{% endblock %}

{% block content_inner %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="max-w-7xl mx-auto mt-10 p-6 bg-white/10 rounded-2xl shadow-lg backdrop-blur border border-white/20">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-white">Fee Plans</h1>
    <a href="{% url 'adminportal:fee_plan_create' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
      + New Plan
    </a>
  </div>

  <!-- Filters -->
  <form method="GET" class="flex flex-col md:flex-row gap-4 mb-8">

    <!-- Status Dropdown (Alpine) -->
    <div x-data="{ open:false, selected:'{{ request.GET.status|default:'' }}' }" class="relative w-48">
      <button type="button" @click="open = !open"
              class="w-full px-4 py-2 bg-transparent border border-white/20 rounded-lg text-white flex justify-between items-center focus:outline-none">
        <span x-text="selected
              ? ($refs.list.querySelector(`[data-value='${selected}']`)?.innerText || 'Select Status')
              : 'All Statuses'"></span>
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="open" @click.away="open=false" x-ref="list"
           class="absolute z-30 mt-2 w-full bg-white/10 backdrop-blur border border-white/20 rounded-lg shadow-lg">
        <button type="submit" name="status" value=""
                @click="selected=''; open=false"
                class="w-full text-left px-4 py-2 text-white hover:bg-white/20">
          All Statuses
        </button>
        {% for val,label in statuses %}
          <button type="submit" name="status" value="{{ val }}" data-value="{{ val }}"
                  @click="selected='{{ val }}'; open=false"
                  :class="selected == '{{ val }}' ? 'bg-white/20' : ''"
                  class="w-full text-left px-4 py-2 text-white hover:bg-white/20">
            {{ label }}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- Search -->
    <input type="text" name="q" value="{{ request.GET.q }}"
           placeholder="Search by student name, email, or description…"
           class="md:w-72 px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20 placeholder-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />

    <button type="submit"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
      Filter
    </button>
  </form>

  <!-- Aggregates -->
  <div class="mb-4 text-sm text-gray-200">
    <span class="mr-4">Total Plans:
      <strong>{{ aggregates.count|default:"0" }}</strong>
    </span>
    <span>Total Amount:
      <strong>RM {{ aggregates.total|default:"0.00" }}</strong>
    </span>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white/5 border border-white/10 rounded-xl text-white">
      <thead class="bg-white/10 text-left text-sm uppercase font-semibold">
        <tr>
          <th class="p-4">#</th>
          <th class="p-4">Student</th>
          <th class="p-4">Email</th>
          <th class="p-4">Description</th>
          <th class="p-4">Start</th>
          <th class="p-4">Months</th>
          <th class="p-4">Total (RM)</th>
          <th class="p-4">Monthly (RM)</th>
          <th class="p-4">Status</th>
          <th class="p-4">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in plans %}
        <tr class="border-t border-white/10 hover:bg-white/5 transition">
          <td class="p-4">{{ forloop.counter }}</td>
          <td class="p-4 font-medium">
            {{ p.student.user.get_full_name|default:"N/A" }}
          </td>
          <td class="p-4">
            {{ p.student.user.email|default:"-" }}
          </td>
          <td class="p-4">
            {{ p.description|default:"—" }}
          </td>
          <td class="p-4">
            {{ p.start_date|date:"Y-m-d" }}
          </td>
          <td class="p-4">
            {{ p.months }}
          </td>
          <td class="p-4">
            {{ p.total_amount }}
          </td>
          <td class="p-4">
            {{ p.monthly_amount }}
          </td>
          <td class="p-4">
            <span class="px-2 py-1 rounded text-xs
              {% if p.status == 'active' %} bg-emerald-600/30 border border-emerald-400/40
              {% elif p.status == 'draft' %} bg-gray-500/30 border border-gray-400/40
              {% elif p.status == 'completed' %} bg-blue-600/30 border border-blue-400/40
              {% elif p.status == 'cancelled' %} bg-red-600/30 border border-red-400/40
              {% else %} bg-white/20 border border-white/30 {% endif %}">
              {{ p.get_status_display }}
            </span>
          </td>
          <td class="p-4 flex gap-2">
            <a href="{% url 'adminportal:fee_plan_detail' p.id %}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-semibold">
              View
            </a>
            <a href="{% url 'adminportal:fee_plan_generate_installments' p.id %}"
               class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded text-xs font-semibold">
              Generate
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="p-4 text-center text-gray-300">No fee plans found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
